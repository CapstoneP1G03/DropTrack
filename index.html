<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Droptrack â€“ Smart Durian Detection System</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- GLOBAL STYLES (DARK MODE) --- */
        body {
            font-family: 'Arial', sans-serif; background-color: #121212; 
            color: #e0e0e0; text-align: center; margin: 0; padding: 0;
        }

        /* --- LOGO & HEADER STYLING --- */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 20px;
            gap: 15px;
        }
        .main-logo {
            width: 60px;
            height: auto;
            filter: drop-shadow(0 0 5px rgba(0, 230, 118, 0.3));
        }
        h1 { color: #ffffff; margin: 0; }

        /* --- COUNTER AND RESET BUTTON --- */
        #fall-counter-container {
            display: flex; justify-content: center; gap: 20px; margin-top: 20px;
        }
        #fall-counter-display {
            margin: 10px 0; font-size: 1.2em; color: #00e676; 
            background-color: #1e1e1e; padding: 15px; border-radius: 8px; 
            max-width: 400px;
        }
        #reset-button {
            background-color: #ff9800; color: #121212; border: none; 
            padding: 15px 30px; border-radius: 8px; cursor: pointer; 
            font-weight: bold; margin: 10px 0;
            transition: background-color 0.3s;
        }
        #reset-button:hover { background-color: #e68a00; }

        /* --- SECTION BOX STYLING --- */
        #data-sections {
            display: flex; justify-content: center; gap: 30px; padding: 30px; flex-wrap: wrap;
        }
        .section-box {
            background-color: #1e1e1e; padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); width: 40%; 
            min-width: 300px; cursor: pointer; transition: all 0.5s;
            border: 2px solid #555;
        }
        
        /* NEW: GREEN for Durian Fall Detection */
        .status-alert-durian {
            background-color: #004d26; border: 2px solid #00e676; 
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.5); color: #fff;
        }

        /* NEW: RED for Monkey Detection */
        .status-alert-monkey {
            background-color: #4a0000; border: 2px solid #ff1744; 
            box-shadow: 0 0 20px rgba(255, 23, 68, 0.5); color: #fff;
        }

        .status-default { border: 2px solid #555; color: #b0b0b0; }
        
        /* --- EVENT LOG STYLING --- */
        #event-log-area {
            background-color: #1e1e1e; padding: 20px; margin: 0 auto;
            max-width: 800px; border-radius: 12px; margin-top: 20px;
        }
        #events-log { 
            list-style-type: none; padding: 0; text-align: left;
            max-height: 300px; overflow-y: auto; 
        }
        #events-log li { padding: 8px 0; border-bottom: 1px dotted #333; }

        /* --- MODAL STYLING --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; overflow-y: auto; }
        .modal-content-box { background: #1e1e1e; color: #fff; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; margin: 10% auto; max-height: 80vh; overflow-y: auto; }
        .close-button-outside { position: absolute; top: 8%; right: 12%; color: #fff; background: none; border: none; font-size: 2.2em; font-weight: bold; cursor: pointer; z-index: 101; text-shadow: 0 0 5px rgba(0,0,0,0.8); }
        
        .log-item { border-bottom: 1px solid #444; padding: 10px 0; text-align: left; }
        .log-time { color: #ff9800; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-container">
        <img src="image_5fef39.png" alt="Durian Logo" class="main-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3655/3655416.png'">
        <h1>Droptrack Dashboard</h1>
    </div>

    <div id="fall-counter-container">
        <div id="fall-counter-display">
            Total Durians Detected: <strong id="durian-count">0</strong>
        </div>
        <button onclick="resetData()" id="reset-button">Collected (Reset Data)</button>
    </div>

    <div id="data-sections">
        <div id="fall-detection-section" class="section-box status-default" onclick="showDetails('fall')">
            <h2>Durian Fall Detection</h2>
            <p id="fall-status">Monitoring...</p>
            <p id="current-weight">Weight: 0.00 kg</p>
        </div>

        <div id="monkey-detection-section" class="section-box status-default" onclick="showDetails('intrusion')">
            <h2>Monkey Detection</h2>
            <p id="monkey-status">Area Clear</p>
        </div>
    </div>

    <div id="detail-modal" class="modal">
        <button class="close-button-outside" onclick="document.getElementById('detail-modal').style.display='none'">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-content-box">
            <h3 id="modal-title">Details</h3>
            <div id="modal-content-body"></div>
        </div>
    </div>

    <div id="event-log-area">
        <h2>Recent Events Log</h2>
        <ul id="events-log"><li>Awaiting events...</li></ul>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBV5R26svE_ukJOyPsx1XSvRSQ0UYrpuLM", 
            authDomain: "capstone-p1g03.firebaseapp.com",
            databaseURL: "https://capstone-p1g03-default-rtdb.firebaseio.com/", 
            projectId: "capstone-p1g03",
            storageBucket: "capstone-p1g03.firebasestorage.app",
            appId: "1:438598479102:web:78de052448974beef249af"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let allConfirmedIntrusions = []; 
        let allConfirmedFalls = []; 

        // Listen for Intrusions (Text logs)
        db.ref('intrusion_images').on('value', (snapshot) => {
            allConfirmedIntrusions = []; 
            snapshot.forEach((child) => {
                allConfirmedIntrusions.push(child.val());
            });
            allConfirmedIntrusions.sort((a, b) => b.timestamp - a.timestamp);
        });
        
        // Listen for Fall History
        db.ref('fall_events_log').on('value', (snapshot) => {
            allConfirmedFalls = [];
            snapshot.forEach((child) => {
                allConfirmedFalls.push(child.val());
            });
            allConfirmedFalls.sort((a, b) => b.timestamp - a.timestamp);
        });

        // Listen for Counter
        db.ref('metrics/durian_fall_count').on('value', (snapshot) => {
            document.getElementById('durian-count').textContent = snapshot.val() || 0;
        });

        // Real-Time Status & Colors
        db.ref('orchard_status/zone_a').on('value', (snapshot) => {
            const data = snapshot.val() || { net_weight_g: 0, fall_detected: false, intrusion_detected: false };
            
            document.getElementById('current-weight').textContent = `Weight: ${(data.net_weight_g / 1000).toFixed(2)} kg`; 

            // Durian Box (GREEN)
            const fBox = document.getElementById('fall-detection-section');
            if (data.fall_detected) {
                document.getElementById('fall-status').textContent = "DURIAN FALL DETECTED!";
                fBox.className = "section-box status-alert-durian";
            } else {
                document.getElementById('fall-status').textContent = "Monitoring...";
                fBox.className = "section-box status-default";
            }

            // Monkey Box (RED)
            const mBox = document.getElementById('monkey-detection-section');
            if (data.intrusion_detected) {
                document.getElementById('monkey-status').textContent = "MONKEY ALERT!";
                mBox.className = "section-box status-alert-monkey";
            } else {
                document.getElementById('monkey-status').textContent = "Area Clear";
                mBox.className = "section-box status-default";
            }
        });

        // Bottom log list
        db.ref('fall_events_log').limitToLast(10).on('child_added', (snapshot) => {
            const data = snapshot.val();
            const time = new Date(data.timestamp * 1000).toLocaleTimeString();
            const li = document.createElement('li');
            li.style.color = data.alert_status.includes("FALL") ? '#00e676' : '#ff9800';
            li.innerHTML = `[${time}] <strong>${data.alert_status}</strong> (${(data.net_weight_g/1000).toFixed(2)} kg)`;
            const log = document.getElementById('events-log');
            log.prepend(li);
            if (log.lastChild && log.lastChild.textContent.includes('Awaiting')) { log.removeChild(log.lastChild); }
        });

        function showDetails(type) {
            const body = document.getElementById('modal-content-body');
            document.getElementById('modal-title').textContent = type === 'fall' ? "Fall History" : "Intrusion History";
            body.innerHTML = "";

            const dataList = type === 'fall' ? allConfirmedFalls : allConfirmedIntrusions;
            if (dataList.length === 0) {
                body.innerHTML = "<p>No logs available.</p>";
            } else {
                dataList.forEach(item => {
                    const time = new Date(item.timestamp * 1000).toLocaleString();
                    const detail = type === 'fall' ? `${(item.net_weight_g/1000).toFixed(2)} kg` : "Alarm Activated";
                    body.innerHTML += `<div class="log-item"><span class="log-time">${time}</span><br>Status: ${detail}</div>`;
                });
            }
            document.getElementById('detail-modal').style.display = 'block';
        }

        function resetData() {
            if (!confirm("Are you sure you want to reset ALL data?")) return;
            db.ref().update({
                'metrics/durian_fall_count': 0,
                'fall_events_log': null,
                'intrusion_images': null
            }).then(() => {
                alert("Data Reset Successfully!");
                location.reload();
            });
        }
    </script>
</body>
</html>