<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Droptrack – Smart Durian Detection System</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- GLOBAL STYLES (DARK MODE) --- */
        body {
            font-family: 'Arial', sans-serif; background-color: #121212; 
            color: #e0e0e0; text-align: center; margin: 0; padding: 0;
        }

        /* --- LOGO & HEADER STYLING --- */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 20px;
            gap: 15px;
        }
        .main-logo {
            width: 70px;
            height: auto;
            filter: drop-shadow(0 0 5px rgba(0, 230, 118, 0.3));
        }
        h1 { color: #00e676; margin: 0; }

        /* --- COUNTER AND RESET BUTTON --- */
        #fall-counter-container {
            display: flex; justify-content: center; gap: 20px; margin-top: 20px;
        }
        #fall-counter-display {
            margin: 10px 0; font-size: 1.2em; color: #00e676; 
            background-color: #1e1e1e; padding: 15px; border-radius: 8px; 
            max-width: 400px;
        }
        #reset-button {
            background-color: #ff9800; color: #121212; border: none; 
            padding: 15px 30px; border-radius: 8px; cursor: pointer; 
            font-weight: bold; margin: 10px 0;
            transition: background-color 0.3s;
        }
        #reset-button:hover { background-color: #e68a00; }

        /* --- SECTION BOX STYLING --- */
        #data-sections {
            display: flex; justify-content: center; gap: 30px; padding: 30px; flex-wrap: wrap;
        }
        .section-box {
            background-color: #1e1e1e; padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); width: 40%; 
            min-width: 300px; cursor: pointer; transition: all 0.5s;
        }
        .status-default { border: 2px solid #555; color: #b0b0b0; }
        .status-alert {
            background-color: #005020; border: 2px solid #00e676; 
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.5); color: #fff;
        }
        
        /* --- LOG & MODAL STYLING --- */
        #event-log-area { background-color: #1e1e1e; padding: 20px; margin: 20px auto; max-width: 800px; border-radius: 12px; }
        #events-log { list-style-type: none; padding: 0; text-align: left; max-height: 300px; overflow-y: auto; }
        #events-log li { padding: 8px 0; border-bottom: 1px dotted #333; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; overflow-y: auto; }
        .modal-content-box { background: #1e1e1e; color: #fff; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; margin: 10% auto; max-height: 80vh; overflow-y: auto; }
        
        .close-button-outside { 
            position: absolute; top: 8%; right: 12%; color: #fff; background: none; border: none;
            font-size: 2.2em; font-weight: bold; cursor: pointer; z-index: 101; text-shadow: 0 0 5px rgba(0,0,0,0.8); 
        }

        .intrusion-log-item {
            border-bottom: 1px solid #444;
            padding: 10px 0;
            text-align: left;
        }
        .intrusion-time { color: #ff9800; font-weight: bold; }
        .intrusion-status { color: #00e676; font-size: 0.9em; }
    </style>
</head>
<body>

    <div class="header-container">
        <img src="image_5fef39.png" alt="Durian Logo" class="main-logo">
        <h1>Droptrack – Smart Durian Detection System</h1>
    </div>

    <div id="fall-counter-container">
        <div id="fall-counter-display">
            Total Durians Detected: <strong id="durian-count">0</strong>
        </div>
        <button onclick="resetData()" id="reset-button">Collected (Reset Data)</button>
    </div>

    <div id="data-sections">
        <div id="fall-detection-section" class="section-box status-default" onclick="showDetails('fall')">
            <h2>Durian Fall Detection</h2>
            <p id="fall-status">Awaiting Data...</p>
            <p id="current-weight">Weight: 0.00 kg</p>
        </div>

        <div id="monkey-detection-section" class="section-box status-default" onclick="showDetails('intrusion')">
            <h2>Monkey Detection</h2>
            <p id="monkey-status">Awaiting Data...</p>
        </div>
    </div>

    <div id="detail-modal" class="modal">
        <button class="close-button-outside" onclick="document.getElementById('detail-modal').style.display='none'">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-content-box">
            <h3 id="modal-title">Details</h3>
            <div id="modal-content-body"></div>
        </div>
    </div>

    <div id="event-log-area">
        <h2>Recent Events Log</h2>
        <ul id="events-log"><li>Awaiting events...</li></ul>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBV5R26svE_ukJOyPsx1XSvRSQ0UYrpuLM", 
            authDomain: "capstone-p1g03.firebaseapp.com",
            databaseURL: "https://capstone-p1g03-default-rtdb.firebaseio.com/", 
            projectId: "capstone-p1g03",
            storageBucket: "capstone-p1g03.firebasestorage.app",
            messagingSenderId: "438598479102",
            appId: "1:438598479102:web:78de052448974beef249af"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const STATUS_PATH = 'orchard_status/zone_a';
        const EVENTS_PATH = 'fall_events_log';
        const COUNT_PATH = 'metrics/durian_fall_count'; 
        const IMAGE_PATH = 'intrusion_images'; 
        
        let allConfirmedIntrusions = []; 
        let allConfirmedFalls = []; 
        let fallTimer = null;
        let intrusionTimer = null;

        // Listen for Intrusion Logs (Text only now)
        db.ref(IMAGE_PATH).on('value', (snapshot) => {
            allConfirmedIntrusions = []; 
            snapshot.forEach((child) => {
                const data = child.val();
                allConfirmedIntrusions.push(data);
            });
            allConfirmedIntrusions.sort((a, b) => b.timestamp - a.timestamp);
        });
        
        // Listen for Fall History
        db.ref(EVENTS_PATH).on('value', (snapshot) => {
            allConfirmedFalls = [];
            snapshot.forEach((child) => {
                const data = child.val();
                if (data.alert_status && data.alert_status.includes("FALL")) { allConfirmedFalls.push(data); }
            });
            allConfirmedFalls.sort((a, b) => b.timestamp - a.timestamp);
        });

        // Listen for Counter
        db.ref(COUNT_PATH).on('value', (snapshot) => {
            const count = snapshot.val();
            if (count !== null) { document.getElementById('durian-count').textContent = count; }
        });

        // Real-Time Status Update
        db.ref(STATUS_PATH).on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const weight_kg = (data.net_weight_g / 1000).toFixed(2); 
                document.getElementById('current-weight').textContent = `Weight: ${weight_kg} kg`; 

                const fStatus = document.getElementById('fall-status');
                const fSection = document.getElementById('fall-detection-section');
                if (data.fall_detected) {
                    fStatus.textContent = "DURIAN FALL DETECTED!";
                    fSection.className = "section-box status-alert";
                } else {
                    fStatus.textContent = "No Fall Detected. (Monitoring)";
                    fSection.className = "section-box status-default";
                }

                const mStatus = document.getElementById('monkey-status');
                const mSection = document.getElementById('monkey-detection-section');
                if (data.intrusion_detected) {
                    mStatus.textContent = "INTRUSION ALERT! (Monkey/Human)";
                    mSection.className = "section-box status-alert";
                } else {
                    mStatus.textContent = "Area Clear. (Monitoring)";
                    mSection.className = "section-box status-default";
                }
            }
        });

        // Recent Event List
        db.ref(EVENTS_PATH).limitToLast(10).on('child_added', (snapshot) => {
            const data = snapshot.val();
            const time = new Date(data.timestamp * 1000).toLocaleTimeString();
            const li = document.createElement('li');
            li.style.color = data.alert_status.includes("FALL") ? '#00e676' : '#ff9800';
            li.innerHTML = `[${time}] <strong>${data.alert_status}</strong>`;
            const log = document.getElementById('events-log');
            log.prepend(li);
            if (log.lastChild && log.lastChild.textContent.includes('Awaiting')) { log.removeChild(log.lastChild); }
        });

        // Clickable Details Function
        function showDetails(type) {
            const modal = document.getElementById('detail-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-content-body');
            body.innerHTML = ""; 

            if (type === 'fall') {
                title.textContent = "Durian Fall Detection Details";
                let list = `<p><strong>Total Logged Falls: ${allConfirmedFalls.length}</strong></p><ul>`;
                allConfirmedFalls.forEach(f => {
                    list += `<li>[${new Date(f.timestamp*1000).toLocaleString()}] ${(f.net_weight_g/1000).toFixed(2)} kg</li>`;
                });
                body.innerHTML = list + "</ul>";
            } else {
                title.textContent = "Intrusion History (No Images)";
                let listHtml = `<p><strong>Total Intruder Alerts: ${allConfirmedIntrusions.length}</strong></p><hr>`;
                
                if(allConfirmedIntrusions.length > 0) {
                    allConfirmedIntrusions.slice(0, 10).forEach(i => {
                        const timeStr = new Date(i.timestamp * 1000).toLocaleString();
                        listHtml += `
                            <div class="intrusion-log-item">
                                <span class="intrusion-time">${timeStr}</span><br>
                                <span class="intrusion-status">Monkey Detected - Alarm Turned ON</span>
                            </div>`;
                    });
                } else {
                    listHtml += "<p>No intrusions logged.</p>";
                }
                body.innerHTML = listHtml;
            }
            modal.style.display = 'block';
        }

        function resetData() {
            if (confirm("Reset ALL project data?")) {
                db.ref().update({ 'metrics/durian_fall_count': 0, 'fall_events_log': null, 'intrusion_images': null }).then(() => {
                    alert("Reset complete.");
                    location.reload();
                });
            }
        }
    </script>
</body>
</html>