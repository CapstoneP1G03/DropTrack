<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Droptrack â€“ Smart Durian Detection System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #121212; color: #e0e0e0; text-align: center; margin: 0; padding: 0; }
        h1 { color: #00e676; padding-top: 20px; }
        #fall-counter-display { margin: 10px 0; font-size: 1.2em; color: #00e676; background-color: #1e1e1e; padding: 15px; border-radius: 8px; display: inline-block; }
        #reset-button { background-color: #ff9800; color: #121212; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #data-sections { display: flex; justify-content: center; gap: 30px; padding: 30px; }
        .section-box { background-color: #1e1e1e; padding: 30px; border-radius: 12px; border: 2px solid #555; width: 40%; cursor: pointer; }
        .status-alert { background-color: #005020; border-color: #00e676; box-shadow: 0 0 20px rgba(0, 230, 118, 0.5); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); overflow-y: auto; }
        .modal-content-box { background: #1e1e1e; padding: 20px; border-radius: 10px; width: 80%; max-width: 500px; margin: 10% auto; }
        .close-button { position: absolute; top: 5%; right: 10%; color: #fff; font-size: 2em; cursor: pointer; }
        .intrusion-image { max-width: 100%; border: 2px solid #ff9800; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Droptrack Dashboard</h1>
    <div id="fall-counter-display">Total Durians: <strong id="durian-count">0</strong></div>
    <button onclick="resetData()" id="reset-button">Reset Data</button>

    <div id="data-sections">
        <div id="fall-box" class="section-box" onclick="showDetails('fall')">
            <h2>Fall Detection</h2>
            <p id="fall-status">Monitoring...</p>
            <p id="current-weight">0.00 kg</p>
        </div>
        <div id="monkey-box" class="section-box" onclick="showDetails('intrusion')">
            <h2>Monkey Detection</h2>
            <p id="monkey-status">Monitoring...</p>
        </div>
    </div>

    <div id="detail-modal" class="modal">
        <span class="close-button" onclick="document.getElementById('detail-modal').style.display='none'">&times;</span>
        <div class="modal-content-box">
            <h3 id="modal-title">Details</h3>
            <div id="modal-body"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBV5R26svE_ukJOyPsx1XSvRSQ0UYrpuLM",
            authDomain: "capstone-p1g03.firebaseapp.com",
            databaseURL: "https://capstone-p1g03-default-rtdb.firebaseio.com/",
            projectId: "capstone-p1g03",
            storageBucket: "capstone-p1g03.appspot.com",
            appId: "1:438598479102:web:78de052448974beef249af"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allFalls = [], allIntrusions = [];

        db.ref('intrusion_images').on('value', s => { 
            allIntrusions = []; 
            s.forEach(c => { if(c.val().status.includes("Confirmed")) allIntrusions.push(c.val()); });
            allIntrusions.sort((a,b) => b.timestamp - a.timestamp);
        });

        db.ref('fall_events_log').on('value', s => {
            allFalls = [];
            s.forEach(c => { if(c.val().alert_status.includes("FALL")) allFalls.push(c.val()); });
            allFalls.sort((a,b) => b.timestamp - a.timestamp);
        });

        db.ref('orchard_status/zone_a').on('value', s => {
            const d = s.val();
            if(!d) return;
            document.getElementById('current-weight').innerText = (d.net_weight_g/1000).toFixed(2) + " kg";
            document.getElementById('fall-box').className = d.alert_status.includes("FALL") ? "section-box status-alert" : "section-box";
        });

        function showDetails(type) {
            const body = document.getElementById('modal-body');
            body.innerHTML = "";
            if(type === 'fall') {
                allFalls.forEach(f => { body.innerHTML += `<p>${new Date(f.timestamp*1000).toLocaleString()}: ${(f.net_weight_g/1000).toFixed(2)}kg</p>`; });
            } else {
                allIntrusions.slice(0, 5).forEach(i => {
                    body.innerHTML += `<div><p>${new Date(i.timestamp*1000).toLocaleString()}</p><img src="${i.image_url}" class="intrusion-image"></div>`;
                });
            }
            document.getElementById('detail-modal').style.display = 'block';
        }

        function resetData() {
            if(confirm("Reset data?")) db.ref().update({'metrics/durian_fall_count': 0, 'fall_events_log': null, 'intrusion_images': null});
        }
    </script>
</body>
</html>