<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Droptrack Dashboard</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #eee; text-align: center; }
        .header { display: flex; align-items: center; justify-content: center; padding: 20px; gap: 15px; }
        .logo { width: 60px; }
        #counter { background: #1e1e1e; padding: 15px; border-radius: 8px; display: inline-block; margin: 20px; border: 1px solid #00e676; }
        
        .container { display: flex; justify-content: center; gap: 20px; padding: 20px; }
        .box { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 350px; border: 2px solid #444; transition: 0.4s; cursor: pointer; }
        
        /* LIGHT UP COLORS */
        .green-light { background: #00331a; border-color: #00e676; box-shadow: 0 0 20px #00e676; }
        .red-light { background: #330000; border-color: #ff1744; box-shadow: 0 0 20px #ff1744; }

        .modal { display: none; position: fixed; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #1e1e1e; margin: 10% auto; padding: 20px; width: 400px; border-radius: 10px; }
        #modal-body p { border-bottom: 1px solid #333; padding: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <img src="image_5fef39.png" class="logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3655/3655416.png'">
        <h1>Droptrack System</h1>
    </div>

    <div id="counter">Total Durians: <span id="count-val">0</span></div>

    <div class="container">
        <div id="durian-box" class="box" onclick="openModal('fall')">
            <h2>Durian Detection</h2>
            <p id="fall-txt">Monitoring...</p>
            <h3 id="weight-txt">0.00 kg</h3>
        </div>
        <div id="monkey-box" class="box" onclick="openModal('monkey')">
            <h2>Monkey Detection</h2>
            <p id="monkey-txt">Area Clear</p>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <button onclick="resetData()" style="background: #ff9800; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Reset History</button>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Log</h2>
            <div id="modal-body" style="text-align: left; max-height: 300px; overflow-y: auto;"></div>
            <button onclick="document.getElementById('myModal').style.display='none'" style="margin-top:15px;">Close</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
        const config = {
            apiKey: "AIzaSyBV5R26svE_ukJOyPsx1XSvRSQ0UYrpuLM",
            databaseURL: "https://capstone-p1g03-default-rtdb.firebaseio.com/",
            projectId: "capstone-p1g03"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        let falls = [], intrusions = [];

        // Real-time Listeners with NULL checks to prevent layout shift
        db.ref('orchard_status/zone_a').on('value', s => {
            const d = s.val() || { net_weight_g: 0, fall_detected: false, intrusion_detected: false };
            
            document.getElementById('weight-txt').innerText = (d.net_weight_g / 1000).toFixed(2) + " kg";
            
            const dBox = document.getElementById('durian-box');
            if(d.fall_detected) { 
                dBox.className = "box green-light"; 
                document.getElementById('fall-txt').innerText = "FALL DETECTED!"; 
            } else { 
                dBox.className = "box"; 
                document.getElementById('fall-txt').innerText = "Monitoring..."; 
            }

            const mBox = document.getElementById('monkey-box');
            if(d.intrusion_detected) { 
                mBox.className = "box red-light"; 
                document.getElementById('monkey-txt').innerText = "MONKEY ALERT!"; 
            } else { 
                mBox.className = "box"; 
                document.getElementById('monkey-txt').innerText = "Area Clear"; 
            }
        });

        db.ref('metrics/durian_fall_count').on('value', s => {
            document.getElementById('count-val').innerText = s.val() || 0;
        });

        db.ref('fall_events_log').on('value', s => {
            falls = [];
            if(s.exists()) s.forEach(c => falls.push(c.val()));
        });

        db.ref('intrusion_images').on('value', s => {
            intrusions = [];
            if(s.exists()) s.forEach(c => intrusions.push(c.val()));
        });

        function openModal(type) {
            const body = document.getElementById('modal-body'); 
            body.innerHTML = "";
            if(type === 'fall') {
                document.getElementById('modal-title').innerText = "Fall History";
                if(falls.length === 0) body.innerHTML = "<p>No data available.</p>";
                [...falls].reverse().forEach(f => {
                    body.innerHTML += `<p>${new Date(f.timestamp*1000).toLocaleString()} - ${(f.net_weight_g/1000).toFixed(2)}kg</p>`;
                });
            } else {
                document.getElementById('modal-title').innerText = "Monkey History";
                if(intrusions.length === 0) body.innerHTML = "<p>No data available.</p>";
                [...intrusions].reverse().forEach(i => {
                    body.innerHTML += `<p>${new Date(i.timestamp*1000).toLocaleString()} - Alarm Triggered</p>`;
                });
            }
            document.getElementById('myModal').style.display = 'block';
        }

        function resetData() {
            if(confirm("Are you sure you want to clear all history? This cannot be undone.")) {
                db.ref().update({
                    'metrics/durian_fall_count': 0,
                    'fall_events_log': null,
                    'intrusion_images': null
                }).then(() => {
                    alert("Data reset successfully.");
                });
            }
        }
    </script>
</body>
</html>